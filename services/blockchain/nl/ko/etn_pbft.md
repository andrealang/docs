---

copyright:
  years: 2016, 2017
lastupdated: "2016-10-13"

---

{:new_window: target="_blank"}
{:shortdesc: .shortdesc}
{:codeblock: .codeblock}
{:screen: .screen}
{:pre: .pre}


# 합의 및 가용성 테스트
{: #etn_pbft}

스타터 개발자 플랜 및 고급 보안 비즈니스 네트워크 플랜을 사용하면 4노드 블록체인 네트워크에서 PBFT(Practical Byzantine Fault Tolerance) 합의 프로토콜을 테스트할 수 있습니다. 다음 주제에서는 일반적인 합의와 특히 PBFT에 대한 세부사항을 제공합니다. 일단 테스트 시작이 준비되면 PBFT 테스트 케이스가 제공됩니다.   
{:shortdesc}  

## 합의의 개념

합의는 블록체인 네트워크에서 요청, 즉 트랜잭션(배치 및 호출)의 순서를 유효성 검증하는 방법입니다. 많은 트랜잭션에 하나 이상의 이전 트랜잭션에 대한 종속성이 있으므로 트랜잭션의 올바른 순서 지정은 중요합니다(예를 들어, 차변 계정에는 종종 이전 대변 계정에 대한 종속 항목이 있음). 

블록체인 네트워크에는 트랜잭션 순서를 결정하는 집중화된 권한이 없습니다. 대신 다수의 유효성 검증 노드(또는 피어)는 네트워크 합의 프로토콜을 구현합니다. 합의는 트랜잭션이 공유 원장에 추가되는 순서에 대해 노드의 정족수가 동의함을 보증합니다. 제안된 트랜잭션 순서의 불일치를 해결하여 합의는 모든 블록체인 네트워크 노드가 동일한 원장에서 작동하도록 보장합니다. 다시 말하면, 합의는 모든 블록체인 네트워크 트랜잭션의 무결성과 일관성을 보장*합니다. 

* 이러한 보장은 구현된 특정 합의 프로토콜 및 블록체인 네트워크의 노드 수 등의 변수에 의존합니다. 두 가지 Blockchain on Bluemix 플랜 모두 PBFT 합의 프로토콜을 구현합니다.   

<br>
## PBFT의 개념

PBFT(Practical Byzantine Fault Tolerance)는 합의 프로토콜의 특성 가운데 하나입니다. 합의 프로토콜의 기능은 이 순서에 대한 위협에도 불구하고 블록체인 네트워크에서 트랜잭션의 순서를 그대로 유지하는 것입니다. 해당 위협 중 하나는 여러 네트워크 노드의 임의의 동시 장애(비잔틴 결함 유형)입니다. PBFT를 사용하여 (N)개 노드의 블록체인 네트워크는 (f) 수만큼의 비잔틴 노드를 허용할 수 있습니다(여기서 f = (N-1)/3). 다시 말하면, PBFT는 공유 원장에 추가되기 전에 트랜잭션의 순서에 대해 최소 2\*f + 1개 노드가 합의에 도달함을 보장합니다. 이러한 공식을 유도하면 모든 네트워크 노드 중 1/3 미만의 비잔틴 결함에도 불구하고 PBFT 네트워크가 데이터 일관성과 무결성을 보장하는 규칙이 드러납니다.   

<br>
## PBFT 및 블록체인 네트워크

2\*f + 1 PBFT 규칙에는 스타터 개발자 플랜 및 고급 보안 비즈니스 네트워크 플랜 모두에 대해 다음과 같은 함의가 있습니다. 

1. 네트워크는 오직 하나의 비잔틴 노드만 허용할 수 있습니다. 각 네트워크에 N=4개의 노드가 포함되어 있으므로, 허용되는 최대 비잔틴 노드 수에 대한 공식을 적용한 결과는 f=(4-1)/3=1입니다. 둘 이상의 비잔틴 노드(f>1)가 존재하면, 4노드 PBFT 네트워크가 모든 노드 간에 원장의 일관성이나 무결성을 보장할 수 없습니다. (비교하자면, 2개의 비잔틴 노드를 허용하려면 f=(7-1)/3=2 또는 최소 7노드 PBFT 블록체인 네트워크가 필요합니다). 
2. PBFT가 노드 간에 데이터 일관성이나 무결성을 보장할 수 없으므로, 2\*f + 1개 미만의 노드가 온라인이면 네트워크가 원장에 추가를 중지합니다. 최소한 2\*f + 1개 노드(이 경우는 3개 또는 4개 노드)가 온라인이면 네트워크는 원장에 추가를 재개합니다. 
3. 트랜잭션의 다음 블록을 처리하기 전에 최소 2\*f + 1개 노드만 합의에 도달해야 하므로, 추가 노드(2\*f + 1 초과)의 원장은 임시로 지연됩니다. 모든 노드 간에 공유 원장의 동기화에서 이러한 지연은 PFBT 네트워크에서는 피할 수 없는 제한사항입니다. 
<br>

## 합의 테스트 케이스
다음의 합의 테스트 케이스가 PBFT에 대한 미팅 네트워크 가용성 표준으로서 IBM에 의해 진단되었습니다. 

1. [비잔틴 노드 없이 PBFT 테스트](pbft_test1.html). 합의 프로세스가 트랜잭션을 실행하고 원장에 추가합니다. 
2. 한 개의 노드를 중지하고 배치, 호출 및 조회 트랜잭션의 전송을 계속하여 [한 개의 비잔틴 노드 시뮬레이션](pbft_test2.html). PBFT 합의 프로세스가 트랜잭션을 실행하고 원장에 추가합니다. 이 테스트는 4노드 환경에서 각 노드마다 반복되었습니다. 
3. 두 개의 노드를 중지하고 배치, 호출 및 조회 트랜잭션의 전송을 계속하여 [두 개의 비잔틴 노드 시뮬레이션](pbft_test3.html). PBFT 합의의 도달에 실패했으므로 트랜잭션이 실행되지 않거나 원장에 추가되지 않습니다. 
4. 이전 테스트 케이스(테스트 3)에서 [중지된 하나의 노드 다시 시작](pbft_test4.html). PBFT 합의 프로세스가 트랜잭션의 실행과 원장에 추가를 재개합니다. 다시 시작된 노드는 해당 원장을 공유 원장과 동기화합니다.   

주의: 합의 테스트를 시작하기 전에 다음 참고사항을 검토하십시오. 

- 모든 합의 테스트 케이스는 REST API를 사용하여 네트워크 피어와 상호작용합니다. 
- HTTP/2는 통신 프로토콜이며, 테스트 케이스는 피어 URL을 사용합니다. 예: 'VP0–api.dev.blockchain.ibm.com:80'. 기호값 ***VP0, VP1, VP2 및 VP3***이 리터럴 피어 URL의 플레이스홀더로서 사용됩니다. 
-  피어에 로그인하려면 Bluemix 서비스를 배치할 때 제공된 신임 정보를 사용하십시오. 테스트 케이스의 경우, **test\_user1** 및 **test\_user1\_enrollSecret**은 각각 *enrollID* 및 *enrollSecret*의 값으로 사용됩니다. 
-  네트워크 콘솔의 **조치** 단추를 사용하여 피어를 수동으로 중지한 후 다시 시작하여 노드 충돌을 시뮬레이션하십시오. 아래의 그림 1은 **네트워크** 탭의 **조치**를 표시합니다. 

![](images/stopstartpeer.png "피어 중지 및 시작")
*그림 1. 피어 중지 및 시작*

- 테스트 케이스는 기본적으로 다음 주소의 **chaincode_example02**를 사용합니다. https://github.com/hyperledger/fabric/tree/v0.6/examples/chaincode/go/chaincode_example02. 그러나 자체 체인코드를 사용하거나 다음 주소의 체인코드 예제를 사용할 수 있습니다. https://github.com/hyperledger/fabric/tree/v0.6/examples/chaincode/go.
- 요청은 처리를 위해 하나의 트랜잭션으로 일괄처리됩니다. 그러나 일괄처리 제한시간 값에 의지하여 즉각적인 처리를 보장할 수 있습니다. 다음 요청을 제출하기 전에 최소한 2초를 대기하면 트랜잭션이 즉시 처리됩니다. 
