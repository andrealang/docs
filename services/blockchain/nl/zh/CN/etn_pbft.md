---

copyright:
  years: 2016, 2017
lastupdated: "2016-10-13"

---

{:new_window: target="_blank"}
{:shortdesc: .shortdesc}
{:codeblock: .codeblock}
{:screen: .screen}
{:pre: .pre}


# 测试共识和可用性
{: #etn_pbft}

“入门模板开发者”套餐和“高安全性业务网络”套餐都支持在四节点区块链网络上测试实用拜占庭容错 (PBFT) 共识协议。以下主题提供了有关共识的一般详细信息以及 PBFT 的具体详细信息。一旦准备好开始测试，即提供了 PBFT 测试用例。
  
{:shortdesc}  

## 什么是共识？

共识是一种用于在区块链网络上验证请求或交易（部署和调用）的顺序的方法。对交易正确排序至关重要，因为许多交易对一个或多个先前的交易具有依赖关系（例如，帐户借记通常对先前的贷记具有依赖关系）。

在区块链网络上，没有集中的权限用于确定交易顺序；而是由大量验证节点（或同级）来实现网络共识协议。共识可确保一组定额的节点就附加到共享分类帐的交易的顺序达成一致。通过解决所建议交易顺序中的任何不一致，共识可保证所有区块链网络节点都在完全相同的分类帐上运行。换句话说，共识可保证*所有区块链网络交易的完整性和一致性。

* 此保证依赖于多个变量，例如实现的特定共识协议以及区块链网络中的节点数。这两个 Blockchain on Bluemix 套餐都实现的是 PBFT 共识协议。  

<br>
## 什么是 PBFT？

实用拜占庭容错 (PBFT) 是一种类型的共识协议。共识协议的功能是维护区块链网络上交易的顺序，抵御对此顺序构成的威胁。其中一个此类威胁是多个网络节点发生任意并发故障（一种类型的拜占庭故障）。使用 PBFT，(N) 个节点组成的区块链网络可以抵御 (f) 个拜占庭节点，其中 f = (N-1)/3。换句话说，PBFT 可确保在将交易附加到共享分类帐之前，至少有 2\*f + 1 个节点就交易顺序达成共识。推导任一公式揭示出的规则是，只要拜占庭故障数少于所有网络节点数的三分之一，PBFT 网络就能保证数据一致性和完整性。  

<br>
## PBFT 和区块链网络

2\*f + 1 PBFT 规则对于“入门模板开发者”套餐和“高安全性业务网络”套餐有以下影响：

1. 网络最多只能容忍一个拜占庭节点。每个网络包含 N=4 个节点，所以应用最大容忍拜占庭节点数的公式得到的结果是：f=(4-1)/3=1。如果存在两个或更多拜占庭节点 (f>1)，那么 4 节点 PBFT 网络无法保证分类帐在所有节点上的一致性或完整性。（比较一下，容忍两个拜占庭节点将需要 f=(7-1)/3=2，即最少 7 个节点的 PBFT 区块链网络。）
2. 如果联机的节点数少于 2\*f + 1，那么网络会停止附加到分类帐，因为 PBFT 无法保证各节点上的数据一致性或完整性。当联机节点数至少为 2\*f + 1（在本例中，为 3 个或 4 个节点）时，网络将恢复附加到分类帐。
3. 由于只需最少 2\*f + 1 个节点达成共识即可继续处理下一个交易区块，因此任何新增节点（2\*f + 1 之后的节点）上的分类帐都将暂时滞后。在同步所有节点上共享分类帐时的这种滞后行为是任何 PFBT 网络上不可避免的限制。
<br>

## 共识测试用例
以下共识测试用例已经过 IBM 验证，认为符合 PBFT 的网络可用性标准：

1. [测试没有拜占庭节点的 PBFT](pbft_test1.html)。共识过程会执行交易并附加到分类帐。
2. 通过停止一个节点，并继续发送部署、调用和查询交易来[模拟一个拜占庭节点](pbft_test2.html)。PBFT 共识过程会执行交易并附加到分类帐。此测试会对四节点环境中的每个节点重复。
3. 通过停止两个节点，并继续发送部署、调用和查询交易来[模拟两个拜占庭节点](pbft_test3.html)。由于未能达成 PBFT 共识，因此交易不会执行，也不会附加到分类帐。
4. [重新启动前一个测试用例（测试 3）中停止的一个节点](pbft_test4.html)。PBFT 共识过程会恢复执行交易并附加到分类帐。已重新启动的节点会将其分类帐与共享分类帐同步。  

注意：启动共识测试之前，请查看以下说明：

- 所有共识测试用例都使用 REST API 与网络同级进行交互。
- HTTP/2 是其通信协议；测试用例使用同级 URL。例如：“VP0–api.dev.blockchain.ibm.com:80”。符号值 ***VP0、VP1、VP2 和 VP3*** 用作字面同级 URL 的占位符。
-  要登录到同级，请使用部署 Bluemix 服务时提供的凭证。对于测试用例，**test\_user1** 和 **test\_user1\_enrollSecret** 分别用作 *enrollID* 和 *enrollSecret* 的值。
-  通过网络控制台上的**操作**按钮手动停止并重新启动同级，以模拟节点崩溃。下面的图 1 显示了**网络**选项卡上的**操作**：

![](images/stopstartpeer.png "停止和启动同级")
*图 1. 停止和启动同级*

- 缺省情况下，测试用例使用以下位置中的 **chaincode_example02**：https://github.com/hyperledger/fabric/tree/v0.6/examples/chaincode/go/chaincode_example02。但是，您可以使用自己的链代码或以下位置的任一链代码示例：https://github.com/hyperledger/fabric/tree/v0.6/examples/chaincode/go。
- 请求会分批到一个交易中进行处理。但是，可以通过依赖批处理超时值来确保立即处理；提交下一个请求之前，请至少等待 2 秒，随后将立即处理交易。
