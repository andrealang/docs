---

copyright:
  years: 2016, 2017
lastupdated: "2016-10-13"

---

{:new_window: target="_blank"}
{:shortdesc: .shortdesc}
{:codeblock: .codeblock}
{:screen: .screen}
{:pre: .pre}


# 測試共識及可用性
{: #etn_pbft}

「入門範本開發人員」方案及「高安全性商業網路」方案都可讓您在四個節點的區塊鏈網路上測試「實用拜占庭容錯 (PBFT)」共識通訊協定。下列主題提供共識的一般詳細資料，尤其是 PBFT。您準備好開始測試之後，即會提供 PBFT 測試案例。
  
{:shortdesc}  

## 何謂共識？

共識是一種方法，用於驗證區塊鏈網路上的要求或交易（deploy 及 invoke）順序。正確的交易順序十分重要，因為許多交易會依賴一個以上的先前交易（例如，科目的借方項目經常依賴先前的貸方項目）。

在區塊鏈網路上，沒有可決定交易順序的中央管理單位；相反地，許多驗證節點（或對等節點）都會實作網路共識通訊協定。共識確保節點的仲裁會同意交易附加至共用分類帳的順序。藉由解決對所提出之交易順序的任何分歧，共識可保證所有區塊鏈網路節點在相同的分類帳運作。換言之，共識*保證*所有區塊鏈網路交易的完整性與一致性。

* 這項保證依賴的變數包括例如實作的特定共識通訊協定，以及區塊鏈網路中的節點數目。這兩項 Blockchain on Bluemix 方案都會實作 PBFT 共識通訊協定。  

<br>
## 何謂 PBFT？

「實用拜占庭容錯 (PBFT)」是一種共識通訊協定。共識通訊協定的功能是要維護區塊鏈網路上的交易順序，而不管此順序的威脅。這類威脅之一，是多個網路節點的任意且同時失敗（一種「拜占庭」錯誤）。使用 PBFT，(N) 個節點的區塊鏈網路可以承受 (f) 個拜占庭節點，其中 f = (N-1)/3。換言之，PBFT 確保最少 2\*f + 1 個節點達成交易順序共識，然後才將它們附加至共用分類帳。衍生任一公式都會呈現出 PBFT 網路保證資料一致性及完整性的規則，而不管在少於所有網路節點 1/3 的節點上發生拜占庭錯誤。  

<br>
## PBFT 及區塊鏈網路

2\*f + 1 的 PBFT 規則對於「入門範本開發人員」方案及「高安全性商業網路」方案具有下列含意：

1. 網路只能容忍一個拜占庭節點。每一個網路都包含 N=4 個節點，因此套用最大容忍拜占庭節點數目的公式會得到：f=(4-1)/3=1。如果有兩個以上的拜占庭節點 (f>1)，則 4 個節點的 PBFT 網路將無法保證所有節點之間的分類帳一致性或完整性。（為了比較起見，容忍兩個拜占庭節點時需要 f=(7-1)/3=2，也就是最少 7 個節點的 PBFT 區塊鏈網路。）
2. 如果少於 2\*f + 1 個節點在線上，網路會停止附加至分類帳，因為 PBFT 無法保證各節點的資料一致性或完整性。至少有 2\*f + 1 個節點是線上時（在本案例中為三個或四個節點），網路將會繼續附加至分類帳。
3. 因為必須有最少 2\*f + 1 個節點達成共識，才能繼續進行下一個區塊的交易，所以任何其他節點（2\*f + 1 以外）上的分類帳將會暫時落後。同步所有節點之共用分類帳時的這種落後，是任何 PFBT 網路的必然限制。
<br>

## 共識測試案例
IBM 已經審查過下列共識測試案例，認定它們達到 PBFT 的網路可用性標準：

1. [測試沒有拜占庭節點的 PBFT](pbft_test1.html)。共識程序會執行交易，並附加至分類帳。
2. 停止一個節點並繼續傳送 deploy、invoke 及 query 交易，以[模擬一個拜占庭節點](pbft_test2.html)。PBFT 共識程序會執行交易，並附加至分類帳。已針對四節點環境中的每一個節點重複此測試。
3. 停止兩個節點並繼續傳送 deploy、invoke 及 query 交易，以[模擬兩個拜占庭節點](pbft_test3.html)。由於無法達成 PBFT 共識，所以不會執行交易，也不會將其附加至分類帳。
4. [重新啟動在前一個測試案例 (3) 中停止的一個節點](pbft_test4.html)。PBFT 共識程序會繼續執行交易，並附加至分類帳。已重新啟動的節點會同步其分類帳與共用分類帳。  

注意：開始共識測試之前，請檢閱下列注意事項：

- 所有共識測試案例都會使用 REST API 以與網路對等節點互動。
- 通訊協定為 HTTP/2；測試案例使用對等節點 URL。例如：'VP0–api.dev.blockchain.ibm.com:80'。符號值 ***VP0、VP1、VP2 及 VP3*** 用來作為照字面的對等節點 URL 的位置保留元。
-  若要登入對等節點，請使用在部署 Bluemix 服務時所提供的認證。針對測試案例，**test\_user1** 及 **test\_user1\_enrollSecret** 分別用來作為 *enrollID* 及 *enrollSecret* 的值。
-  使用網路主控台上的**動作**按鈕手動停止及重新啟動對等節點，以模擬節點損毀。下面的圖 1 顯示**網路**標籤上的**動作**：

![](images/stopstartpeer.png "停止及啟動對等節點")
*圖 1. 停止及啟動對等節點*

- 依預設，測試案例會使用此處的 **chaincode_example02**：https://github.com/hyperledger/fabric/tree/v0.6/examples/chaincode/go/chaincode_example02。不過，您可以使用自己的鏈碼，或是此處的任何鏈碼範例：https://github.com/hyperledger/fabric/tree/v0.6/examples/chaincode/go。
- 要求會批次處理成一個交易，以進行處理。不過，您可以根據批次逾時值來確保立即處理；提交下一個要求之前至少等待兩秒，將立即處理交易。
