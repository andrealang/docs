---

copyright:
  years: 2016, 2017
lastupdated: "2016-10-13"

---

{:new_window: target="_blank"}
{:shortdesc: .shortdesc}
{:codeblock: .codeblock}
{:screen: .screen}
{:pre: .pre}


# コンセンサスと可用性のテスト
{: #etn_pbft}

Starter Developer プランと High Security Business Network プランでは、4 つのノードのブロックチェーン・ネットワークに対して Practical Byzantine Fault Tolerance (PBFT) コンセンサス・プロトコルをテストすることができます。以下のトピックは、一般的なコンセンサスと、特に PBFT に関する詳細を提供します。テストを開始する準備が整ったら、PBFT テスト・ケースが提供されます。
  
{:shortdesc}  

## コンセンサスとは

コンセンサスは、ブロックチェーン・ネットワークで、要求つまりトランザクション (デプロイと呼び出し) の順序を検証するための方法です。トランザクションの正しい順序は重要です。多くのトランザクションには、以前の 1 つ以上のトランザクションに対する依存関係があるからです (例えば、勘定科目の借方には多くの場合、前の貸方に対する依存関係があります)。

ブロックチェーン・ネットワークには、トランザクションの順序を決める集中化された権限がありません。代わりに、多くの検証ノード (またはピア) がネットワーク・コンセンサス・プロトコルを実装します。コンセンサスは、ノードのクォーラムが、トランザクションが共有台帳に追加される順序に同意するようにします。提案されたトランザクション順序での矛盾を解決することにより、コンセンサスは、すべてのブロックチェーン・ネットワーク・ノードが同一の台帳で動作するようにします。言い換えると、コンセンサスは、すべてのブロックチェーン・ネットワーク・トランザクションの保全性と整合性を保証します。*

* この保証は、実装された特定のコンセンサス・プロトコルや、ブロックチェーン・ネットワーク内のノードの数などの可変要素に依存しています。Bluemix プランのどちらのブロックチェーンにも、PBFT コンセンサス・プロトコルが実装されています。  

<br>
## PBFT とは

Practical Byzantine Fault Tolerance (PBFT) は、コンセンサス・プロトコルの 1 つのフレーバーです。コンセンサス・プロトコルの役割は、この順序に対する脅威にかかわらず、ブロックチェーン・ネットワークでトランザクションの順序を維持することです。その脅威の 1 つには、複数のネットワーク・ノードでの同時に起きる任意障害が挙げられます (一種のビザンチン障害)。PBFT を使用すると、(N) 個のノードが含まれるブロックチェーン・ネットワークは、(f) 個までのビザンチン・ノードに持ちこたえます (f = (N-1)/3)。言い換えると、PBFT により、トランザクションを共有台帳に追加する前に少なくとも 2\*f + 1 個のノードがトランザクションの順序についてコンセンサスを得るようになります。いずれかの数式を導くことで、PBFT ネットワークは、全ネットワーク・ノードの 1/3 未満のビザンチン障害があってもデータの一貫性と整合性を保証するというルールが明らかになります。  

<br>
## PBFT とブロックチェーン・ネットワーク

2\*f + 1 PBFT ルールには、Starter Developer プランと High Security Business Network プランの両方について、以下の含意があります。

1. ネットワークは、1 個以下のビザンチン・ノードに耐えられます。各ネットワークには N=4 個のノードが含まれるため、許容されたビザンチン・ノードの最大数の数式を適用すると、f=(4-1)/3=1 になります。2 つ以上のビザンチン・ノード (f>1) が存在する場合、4 つのノードの PBFT ネットワークは、すべてのノードの台帳の一貫性または整合性を保証できません。(ちなみに、2 つのビザンチン・ノードに耐えるには f=(7-1)/3=2、つまり、7 個以上のノードの PBFT ブロックチェーン・ネットワークが必要になります。)
2. 2\*f + 1 個未満のノードがオンラインの場合、ネットワークは、台帳への追加を中止します。PBFT は、複数ノードにわたるデータの整合性または保全性を保証できないからです。少なくとも 2\*f + 1 個のノードがオンラインになると (この場合は 3 つまたは 4 つのノード)、ネットワークは、台帳への追加を再開します。
3. 2\*f + 1 個以上のノードだけがコンセンサスに到達する必要があるため、トランザクションの次のブロックに進む前に、追加ノード (2\*f + 1 を超える分) の台帳は、一時的に後れを取ります。すべてのノードで共有台帳を同期する際のこの遅れは、どの PFBT ネットワークにおいても避けられない制約です。
<br>

## コンセンサス・テスト・ケース
以下のコンセンサス・テスト・ケースは、PBFT に関するネットワークの可用性標準を満たすものとして IBM によって十分に吟味されました。

1. [ビザンチン・ノードがない場合の PBFT のテスト](pbft_test1.html)。コンセンサス・プロセスは、トランザクションを実行し、台帳に追加します。
2. [1 つのビザンチン・ノードをシミュレート](pbft_test2.html)。そのために、1 つのノードを停止し、デプロイ、呼び出し、照会トランザクションの送信を継続します。PBFT コンセンサス・プロセスは、トランザクションを実行し、台帳に追加します。このテストは、4 つのノード環境の各ノードで繰り返されました。
3. [2 つのビザンチン・ノードをシミュレート](pbft_test3.html)。そのために、2 つのノードを停止し、デプロイ、呼び出し、照会トランザクションの送信を継続します。PBFT コンセンサスに到達できないため、トランザクションは実行されず、台帳に追加されません。
4. 直前のテスト・ケース (テスト 3) で[停止された 1 つのノードの再始動](pbft_test4.html)。PBFT コンセンサス・プロセスは、トランザクションの実行と、台帳の追加を再開します。再始動したノードは、その台帳を共有台帳と同期します。  

重要: コンセンサスのテストを開始する前に、以下の注意事項を確認してください。

- コンセンサス・テスト・ケースはすべて、REST API を使用して、ネットワーク・ピアと対話します。
- HTTP/2 が通信プロトコルです。テスト・ケースはピア URL を使用します。例: 'VP0–api.dev.blockchain.ibm.com:80'。シンボリック値 ***VP0、VP1、VP2、および VP3*** は、リテラル・ピア URL のプレースホルダーとして使用されます。
-  ピアにログインするには、Bluemix サービスをデプロイするときに提供された資格情報を使用します。テスト・ケースでは、**test\_user1** と **test\_user1\_enrollSecret** はそれぞれ、*enrollID*、*enrollSecret* の値として使用されます。
-  ネットワーク・コンソールの**「アクション」**ボタンを使用して、ピアを手動で停止し、再始動することにより、ノードのクラッシュをシミュレートします。以下の図 1 は、**「ネットワーク」**タブの**「アクション」**を示しています。

![](images/stopstartpeer.png "ピアの停止と開始")
*図 1. ピアの停止と開始*

- デフォルトでは、テスト・ケースでは https://github.com/hyperledger/fabric/tree/v0.6/examples/chaincode/go/chaincode_example02 にある **chaincode_example02** が使用されます。しかし、独自のチェーンコードや、https://github.com/hyperledger/fabric/tree/v0.6/examples/chaincode/go にあるチェーンコード・サンプルを使用することもできます。
- 要求は、処理のために 1 つのトランザクションにまとめられます。しかし、バッチ・タイムアウト値を使用することで、即時に処理されるようにすることができます。次の要求をサブミットするまでに少なくとも 2 秒待つと、トランザクションが即時に処理されます。
